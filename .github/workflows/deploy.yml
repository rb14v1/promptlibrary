name: Deploy to EC2

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy on EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.EC2_PROJECT_PATH }}

        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'

          set -e
          echo "ðŸš€ Starting Deployment..."

          sudo apt update -y
          sudo apt install -y python3 python3-pip python3-venv nginx git curl build-essential

          echo "ðŸ“¦ Installing Node..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt install -y nodejs

          echo "ðŸ“ Preparing project folder..."
          mkdir -p "$PROJECT_PATH"
          cd "$PROJECT_PATH"

          if [ ! -d ".git" ]; then
            git clone https://github.com/rb14v1/promptlibrary.git .
          else
            git pull origin main
          fi

          echo "ðŸ›  Setting up backend..."
          cd backend
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          deactivate
          cd ..

          echo "âš›ï¸ Building frontend..."
          cd frontend
          npm install
          npm run build
          cd ..

          echo "ðŸ“‚ Copying frontend build to Nginx path..."
          sudo rm -rf /var/www/promptlibrary
          sudo mkdir -p /var/www/promptlibrary
          sudo cp -r frontend/dist/* /var/www/promptlibrary/

          echo "ðŸ”¥ Creating Gunicorn service..."
          sudo bash -c "cat > /etc/systemd/system/gunicorn.service" << 'EOF'
          [Unit]
          Description=Gunicorn for Django App
          After=network.target

          [Service]
          User=ubuntu
          WorkingDirectory=/home/ubuntu/promptlibrary/backend
          ExecStart=/home/ubuntu/promptlibrary/backend/venv/bin/gunicorn --workers 3 --bind unix:/run/gunicorn.sock prompt_library.wsgi:application

          [Install]
          WantedBy=multi-user.target
          EOF

          sudo systemctl daemon-reload
          sudo systemctl restart gunicorn
          sudo systemctl enable gunicorn

          echo "ðŸŒ Configuring Nginx..."
          sudo bash -c "cat > /etc/nginx/sites-available/promptlibrary" << 'EOF'
          server {
              listen 80;
              server_name _;

              root /var/www/promptlibrary;
              index index.html;

              location / {
                  try_files \$uri \$uri/ /index.html;
              }

              location /api/ {
                  proxy_pass http://unix:/run/gunicorn.sock;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
              }

              location /static/ {
                  alias /home/ubuntu/promptlibrary/backend/static/;
              }
          }
          EOF

          sudo ln -sf /etc/nginx/sites-available/promptlibrary /etc/nginx/sites-enabled/
          sudo nginx -t
          sudo systemctl restart nginx

          echo "ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          ENDSSH
